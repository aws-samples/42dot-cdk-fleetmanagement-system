"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AwsIotCoreProvisioningInfraStack = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const custom_resources_1 = require("aws-cdk-lib/custom-resources");
const device_policy_json_1 = __importDefault(require("./device/device-policy.json"));
const provisioning_template_json_1 = __importDefault(require("./device/provisioning-template.json"));
const path = __importStar(require("path"));
const config_1 = require("../config/config");
const device_cc_policy_json_1 = __importDefault(require("./device/device-cc-policy.json"));
class AwsIotCoreProvisioningInfraStack extends aws_cdk_lib_1.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        // Modify testDevicePolicyJson according to Configs and create device policy for device policy
        device_policy_json_1.default.Statement[1].Resource = [
            `arn:aws:iot:${config_1.Config.aws.region}:${config_1.Config.aws.account}:topic/$aws/rules/*`,
            `arn:aws:iot:${config_1.Config.aws.region}:${config_1.Config.aws.account}:topic/` + '${iot:ClientId}'
        ];
        device_policy_json_1.default.Statement[2].Resource = [
            `arn:aws:iot:${config_1.Config.aws.region}:${config_1.Config.aws.account}:topicfilter/` + '${iot:ClientId}'
        ];
        let testDevicePolicy = new aws_cdk_lib_1.aws_iot.CfnPolicy(this, config_1.Config.app.service + "-" + config_1.Config.app.environment + "device-policy", {
            policyDocument: device_policy_json_1.default,
            policyName: config_1.Config.app.service + "-" + config_1.Config.app.environment + "-device-policy",
        });
        // Create role for pre-provisioning lambda for verification of devices
        let rolePreProvisioningLambda = new aws_cdk_lib_1.aws_iam.Role(this, config_1.Config.app.service + "-" + config_1.Config.app.environment + "-pre-provisioning-lambda-role", {
            assumedBy: new aws_cdk_lib_1.aws_iam.ServicePrincipal("lambda.amazonaws.com"),
            description: "AWS IAM role for pre-provisioning lambda",
            roleName: config_1.Config.app.service + "-" + config_1.Config.app.environment + "-pre-provisioning-lambda-role",
        });
        // Crate lambda for pre-provisioning hook and add permission for invoke
        let lambdaPreProvisioningHook = new aws_cdk_lib_1.aws_lambda.Function(this, config_1.Config.app.service + "-" + config_1.Config.app.environment +
            "-pre-provisioning-hook-lambda", {
            code: aws_cdk_lib_1.aws_lambda.Code.fromAsset(path.join(__dirname, "device")),
            handler: "lambda_function.lambda_handler",
            runtime: aws_cdk_lib_1.aws_lambda.Runtime.PYTHON_3_9,
            role: rolePreProvisioningLambda,
            description: "Lambda for pre-provisioning hook",
            functionName: config_1.Config.app.service + "-" + config_1.Config.app.environment + "-pre-provisioning-hook-lambda",
        });
        lambdaPreProvisioningHook.addPermission("InvokePermission", {
            principal: new aws_cdk_lib_1.aws_iam.ServicePrincipal("iot.amazonaws.com"),
            action: "lambda:InvokeFunction",
        });
        // Crate role for provisioning templates and add AWSIoTThingsRegistration policy
        let roleProvisioning = new aws_cdk_lib_1.aws_iam.Role(this, config_1.Config.app.service + "-" + config_1.Config.app.environment + "-provisioning-template-role", {
            assumedBy: new aws_cdk_lib_1.aws_iam.ServicePrincipal("iot.amazonaws.com"),
            description: "AWS IAM role for provisioning services",
            roleName: config_1.Config.app.service + "-" + config_1.Config.app.environment + "-provisioning-template-role",
        });
        roleProvisioning.addManagedPolicy(aws_cdk_lib_1.aws_iam.ManagedPolicy.fromAwsManagedPolicyName("service-role/AWSIoTThingsRegistration"));
        // Create provisioning template
        provisioning_template_json_1.default.Resources.policy.Properties.PolicyName = testDevicePolicy.policyName;
        let testProvisioningTemplate = new aws_cdk_lib_1.aws_iot.CfnProvisioningTemplate(this, config_1.Config.app.service + "-" + config_1.Config.app.environment + "-provision-template", {
            provisioningRoleArn: roleProvisioning.roleArn,
            templateBody: JSON.stringify(provisioning_template_json_1.default),
            enabled: true,
            preProvisioningHook: {
                "payloadVersion": "2020-04-01",
                "targetArn": lambdaPreProvisioningHook.functionArn
            },
            description: "AWS IoT Provisioning Template",
            templateName: config_1.Config.app.service + "-" + config_1.Config.app.environment + "-provision-template",
        });
        // Modify testDeviceClaimCertificatePolicyJson and create vehicle gateway policy for Claim Certificate
        let templateTopicCreate = `arn:aws:iot:${config_1.Config.aws.region}:${config_1.Config.aws.account}:topic/$aws/certificates/create/*`;
        let templateTopicProvisioning = `arn:aws:iot:${config_1.Config.aws.region}:${config_1.Config.aws.account}:topic/$aws/provisioning-templates/${testProvisioningTemplate.templateName}/provision/*`;
        device_cc_policy_json_1.default.Statement[1].Resource = [templateTopicCreate, templateTopicProvisioning];
        let templateTopicFilterCreate = `arn:aws:iot:${config_1.Config.aws.region}:${config_1.Config.aws.account}:topicfilter/$aws/certificates/create/*`;
        let templateTopicFilterProvisioning = `arn:aws:iot:${config_1.Config.aws.region}:${config_1.Config.aws.account}:topicfilter/$aws/provisioning-templates/${testProvisioningTemplate.templateName}/provision/*`;
        device_cc_policy_json_1.default.Statement[2].Resource = [templateTopicFilterCreate, templateTopicFilterProvisioning];
        let testDeviceClaimCertificatePolicy = new aws_cdk_lib_1.aws_iot.CfnPolicy(this, config_1.Config.app.service + "-" + config_1.Config.app.environment + "-claim-certificate-policy", {
            policyDocument: device_cc_policy_json_1.default,
            policyName: config_1.Config.app.service + "-" + config_1.Config.app.environment + "-claim-certificate-policy",
        });
        // Create claim certificate by using AwsCustomResource
        let createKeysAndCertificateForClaimCertificate = new custom_resources_1.AwsCustomResource(this, config_1.Config.app.service + "-" + config_1.Config.app.environment + "-create-keys-and-certificate-for-claim-certificate", {
            onUpdate: {
                service: "Iot",
                action: "createKeysAndCertificate",
                parameters: { setAsActive: true },
                physicalResourceId: custom_resources_1.PhysicalResourceId.fromResponse("certificateId"),
                outputPaths: ["certificateArn", "certificatePem", "keyPair.PublicKey", "keyPair.PrivateKey"],
            },
            policy: custom_resources_1.AwsCustomResourcePolicy.fromSdkCalls({ resources: custom_resources_1.AwsCustomResourcePolicy.ANY_RESOURCE }),
        });
        // Attach policy to claim certificate
        let PolicyPrincipalAttachmentForClaimCertificate = new aws_cdk_lib_1.aws_iot.CfnPolicyPrincipalAttachment(this, config_1.Config.app.service + "-" + config_1.Config.app.environment + "policy-principal-attachment", {
            policyName: testDeviceClaimCertificatePolicy.policyName,
            principal: createKeysAndCertificateForClaimCertificate.getResponseField("certificateArn"),
        });
        let cdkTestS3Bucket = new aws_cdk_lib_1.aws_s3.Bucket(this, 'cdkTestS3Bucket', {
            blockPublicAccess: aws_cdk_lib_1.aws_s3.BlockPublicAccess.BLOCK_ALL,
            versioned: true,
            removalPolicy: aws_cdk_lib_1.RemovalPolicy.RETAIN_ON_UPDATE_OR_DELETE,
            // autoDeleteObjects: true,
            bucketName: config_1.Config.s3BucketName
        });
        // Save the vehicle-gateway certificates and keys to S3
        let keyDeploymentForDeviceClaimCertificate = new aws_cdk_lib_1.aws_s3_deployment.BucketDeployment(this, config_1.Config.app.service + "-" + config_1.Config.app.environment + "put-key-to-s3", {
            destinationBucket: cdkTestS3Bucket,
            sources: [
                aws_cdk_lib_1.aws_s3_deployment.Source.data("claim-certificate/claim.pem", createKeysAndCertificateForClaimCertificate.getResponseField("certificatePem")),
                aws_cdk_lib_1.aws_s3_deployment.Source.data("claim-certificate/claim.public.key", createKeysAndCertificateForClaimCertificate.getResponseField("keyPair.PublicKey")),
                aws_cdk_lib_1.aws_s3_deployment.Source.data("claim-certificate/claim.private.key", createKeysAndCertificateForClaimCertificate.getResponseField("keyPair.PrivateKey")),
            ],
        });
    }
}
exports.AwsIotCoreProvisioningInfraStack = AwsIotCoreProvisioningInfraStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXdzLWlvdC1jb3JlLXByb3Zpc2lvbmluZy1pbmZyYS1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImF3cy1pb3QtY29yZS1wcm92aXNpb25pbmctaW5mcmEtc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSw2Q0FTcUI7QUFDckIsbUVBSXNDO0FBRXRDLHFGQUErRDtBQUMvRCxxR0FBK0U7QUFDL0UsMkNBQTZCO0FBQzdCLDZDQUEwQztBQUMxQywyRkFBa0Y7QUFFbEYsTUFBYSxnQ0FBaUMsU0FBUSxtQkFBSztJQUN2RCxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQWtCO1FBQ3hELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXhCLDhGQUE4RjtRQUM5Riw0QkFBb0IsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxHQUFHO1lBQ3pDLGVBQWUsZUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLElBQUksZUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLHFCQUFxQjtZQUMzRSxlQUFlLGVBQU0sQ0FBQyxHQUFHLENBQUMsTUFBTSxJQUFJLGVBQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxTQUFTLEdBQUcsaUJBQWlCO1NBQ3RGLENBQUE7UUFDRCw0QkFBb0IsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxHQUFHO1lBQ3pDLGVBQWUsZUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLElBQUksZUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLGVBQWUsR0FBRyxpQkFBaUI7U0FDNUYsQ0FBQTtRQUVELElBQUksZ0JBQWdCLEdBQUcsSUFBSSxxQkFBRyxDQUFDLFNBQVMsQ0FDcEMsSUFBSSxFQUFFLGVBQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxHQUFHLEdBQUcsR0FBRyxlQUFNLENBQUMsR0FBRyxDQUFDLFdBQVcsR0FB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b3ZhbFBvbGljeSxcbiAgICBhd3NfczNfZGVwbG95bWVudCxcbiAgICBhd3NfbGFtYmRhIGFzIGxhbWJkYSxcbiAgICBhd3NfaW90IGFzIGlvdCxcbiAgICBhd3NfaWFtIGFzIGlhbSxcbiAgICBhd3NfczMgYXMgczNcbn0gZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQge1xuICAgIEF3c0N1c3RvbVJlc291cmNlLFxuICAgIEF3c0N1c3RvbVJlc291cmNlUG9saWN5LFxuICAgIFBoeXNpY2FsUmVzb3VyY2VJZCxcbn0gZnJvbSBcImF3cy1jZGstbGliL2N1c3RvbS1yZXNvdXJjZXNcIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgdGVzdERldmljZVBvbGljeUpzb24gZnJvbSBcIi4vZGV2aWNlL2RldmljZS1wb2xpY3kuanNvblwiO1xuaW1wb3J0IHRlc3RQcm92aXNpb25pbmdUZW1wbGF0ZUpzb24gZnJvbSBcIi4vZGV2aWNlL3Byb3Zpc2lvbmluZy10ZW1wbGF0ZS5qc29uXCI7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyBDb25maWcgfSBmcm9tIFwiLi4vY29uZmlnL2NvbmZpZ1wiO1xuaW1wb3J0IHRlc3REZXZpY2VDbGFpbUNlcnRpZmljYXRlUG9saWN5SnNvbiBmcm9tIFwiLi9kZXZpY2UvZGV2aWNlLWNjLXBvbGljeS5qc29uXCI7XG5cbmV4cG9ydCBjbGFzcyBBd3NJb3RDb3JlUHJvdmlzaW9uaW5nSW5mcmFTdGFjayBleHRlbmRzIFN0YWNrIHtcbiAgICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IFN0YWNrUHJvcHMpIHtcbiAgICAgICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICAgICAgLy8gTW9kaWZ5IHRlc3REZXZpY2VQb2xpY3lKc29uIGFjY29yZGluZyB0byBDb25maWdzIGFuZCBjcmVhdGUgZGV2aWNlIHBvbGljeSBmb3IgZGV2aWNlIHBvbGljeVxuICAgICAgICB0ZXN0RGV2aWNlUG9saWN5SnNvbi5TdGF0ZW1lbnRbMV0uUmVzb3VyY2UgPSBbXG4gICAgICAgICAgICBgYXJuOmF3czppb3Q6JHtDb25maWcuYXdzLnJlZ2lvbn06JHtDb25maWcuYXdzLmFjY291bnR9OnRvcGljLyRhd3MvcnVsZXMvKmAsXG4gICAgICAgICAgICBgYXJuOmF3czppb3Q6JHtDb25maWcuYXdzLnJlZ2lvbn06JHtDb25maWcuYXdzLmFjY291bnR9OnRvcGljL2AgKyAnJHtpb3Q6Q2xpZW50SWR9J1xuICAgICAgICBdXG4gICAgICAgIHRlc3REZXZpY2VQb2xpY3lKc29uLlN0YXRlbWVudFsyXS5SZXNvdXJjZSA9IFtcbiAgICAgICAgICAgIGBhcm46YXdzOmlvdDoke0NvbmZpZy5hd3MucmVnaW9ufToke0NvbmZpZy5hd3MuYWNjb3VudH06dG9waWNmaWx0ZXIvYCArICcke2lvdDpDbGllbnRJZH0nXG4gICAgICAgIF1cblxuICAgICAgICBsZXQgdGVzdERldmljZVBvbGljeSA9IG5ldyBpb3QuQ2ZuUG9saWN5KFxuICAgICAgICAgICAgdGhpcywgQ29uZmlnLmFwcC5zZXJ2aWNlICsgXCItXCIgKyBDb25maWcuYXBwLmVudmlyb25tZW50ICsgXCJkZXZpY2UtcG9saWN5XCIsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgcG9saWN5RG9jdW1lbnQ6IHRlc3REZXZpY2VQb2xpY3lKc29uLFxuICAgICAgICAgICAgICAgIHBvbGljeU5hbWU6IENvbmZpZy5hcHAuc2VydmljZSArIFwiLVwiICsgQ29uZmlnLmFwcC5lbnZpcm9ubWVudCArIFwiLWRldmljZS1wb2xpY3lcIixcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuXG4gICAgICAgIC8vIENyZWF0ZSByb2xlIGZvciBwcmUtcHJvdmlzaW9uaW5nIGxhbWJkYSBmb3IgdmVyaWZpY2F0aW9uIG9mIGRldmljZXNcbiAgICAgICAgbGV0IHJvbGVQcmVQcm92aXNpb25pbmdMYW1iZGEgPSBuZXcgaWFtLlJvbGUoXG4gICAgICAgICAgICB0aGlzLCBDb25maWcuYXBwLnNlcnZpY2UgKyBcIi1cIiArIENvbmZpZy5hcHAuZW52aXJvbm1lbnQgKyBcIi1wcmUtcHJvdmlzaW9uaW5nLWxhbWJkYS1yb2xlXCIsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoXCJsYW1iZGEuYW1hem9uYXdzLmNvbVwiKSxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogXCJBV1MgSUFNIHJvbGUgZm9yIHByZS1wcm92aXNpb25pbmcgbGFtYmRhXCIsXG4gICAgICAgICAgICAgICAgcm9sZU5hbWU6IENvbmZpZy5hcHAuc2VydmljZSArIFwiLVwiICsgQ29uZmlnLmFwcC5lbnZpcm9ubWVudCArIFwiLXByZS1wcm92aXNpb25pbmctbGFtYmRhLXJvbGVcIixcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuXG4gICAgICAgIC8vIENyYXRlIGxhbWJkYSBmb3IgcHJlLXByb3Zpc2lvbmluZyBob29rIGFuZCBhZGQgcGVybWlzc2lvbiBmb3IgaW52b2tlXG4gICAgICAgIGxldCBsYW1iZGFQcmVQcm92aXNpb25pbmdIb29rID0gbmV3IGxhbWJkYS5GdW5jdGlvbihcbiAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICBDb25maWcuYXBwLnNlcnZpY2UgKyBcIi1cIiArIENvbmZpZy5hcHAuZW52aXJvbm1lbnQgK1xuICAgICAgICAgICAgXCItcHJlLXByb3Zpc2lvbmluZy1ob29rLWxhbWJkYVwiLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCBcImRldmljZVwiKSksXG4gICAgICAgICAgICAgICAgaGFuZGxlcjogXCJsYW1iZGFfZnVuY3Rpb24ubGFtYmRhX2hhbmRsZXJcIixcbiAgICAgICAgICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5QWVRIT05fM185LFxuICAgICAgICAgICAgICAgIHJvbGU6IHJvbGVQcmVQcm92aXNpb25pbmdMYW1iZGEsXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IFwiTGFtYmRhIGZvciBwcmUtcHJvdmlzaW9uaW5nIGhvb2tcIixcbiAgICAgICAgICAgICAgICBmdW5jdGlvbk5hbWU6IENvbmZpZy5hcHAuc2VydmljZSArIFwiLVwiICsgQ29uZmlnLmFwcC5lbnZpcm9ubWVudCArIFwiLXByZS1wcm92aXNpb25pbmctaG9vay1sYW1iZGFcIixcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuICAgICAgICBsYW1iZGFQcmVQcm92aXNpb25pbmdIb29rLmFkZFBlcm1pc3Npb24oXCJJbnZva2VQZXJtaXNzaW9uXCIsIHtcbiAgICAgICAgICAgIHByaW5jaXBhbDogbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKFwiaW90LmFtYXpvbmF3cy5jb21cIiksXG4gICAgICAgICAgICBhY3Rpb246IFwibGFtYmRhOkludm9rZUZ1bmN0aW9uXCIsXG4gICAgICAgIH0pO1xuXG5cbiAgICAgICAgLy8gQ3JhdGUgcm9sZSBmb3IgcHJvdmlzaW9uaW5nIHRlbXBsYXRlcyBhbmQgYWRkIEFXU0lvVFRoaW5nc1JlZ2lzdHJhdGlvbiBwb2xpY3lcbiAgICAgICAgbGV0IHJvbGVQcm92aXNpb25pbmcgPSBuZXcgaWFtLlJvbGUoXG4gICAgICAgICAgICB0aGlzLCBDb25maWcuYXBwLnNlcnZpY2UgKyBcIi1cIiArIENvbmZpZy5hcHAuZW52aXJvbm1lbnQgKyBcIi1wcm92aXNpb25pbmctdGVtcGxhdGUtcm9sZVwiLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKFwiaW90LmFtYXpvbmF3cy5jb21cIiksXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IFwiQVdTIElBTSByb2xlIGZvciBwcm92aXNpb25pbmcgc2VydmljZXNcIixcbiAgICAgICAgICAgICAgICByb2xlTmFtZTogQ29uZmlnLmFwcC5zZXJ2aWNlICsgXCItXCIgKyBDb25maWcuYXBwLmVudmlyb25tZW50ICsgXCItcHJvdmlzaW9uaW5nLXRlbXBsYXRlLXJvbGVcIixcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuICAgICAgICByb2xlUHJvdmlzaW9uaW5nLmFkZE1hbmFnZWRQb2xpY3koXG4gICAgICAgICAgICBpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoXG4gICAgICAgICAgICAgICAgXCJzZXJ2aWNlLXJvbGUvQVdTSW9UVGhpbmdzUmVnaXN0cmF0aW9uXCJcbiAgICAgICAgICAgIClcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBDcmVhdGUgcHJvdmlzaW9uaW5nIHRlbXBsYXRlXG4gICAgICAgIHRlc3RQcm92aXNpb25pbmdUZW1wbGF0ZUpzb24uUmVzb3VyY2VzLnBvbGljeS5Qcm9wZXJ0aWVzLlBvbGljeU5hbWUgPSB0ZXN0RGV2aWNlUG9saWN5LnBvbGljeU5hbWUhXG5cbiAgICAgICAgbGV0IHRlc3RQcm92aXNpb25pbmdUZW1wbGF0ZSA9IG5ldyBpb3QuQ2ZuUHJvdmlzaW9uaW5nVGVtcGxhdGUoXG4gICAgICAgICAgICB0aGlzLCBDb25maWcuYXBwLnNlcnZpY2UgKyBcIi1cIiArIENvbmZpZy5hcHAuZW52aXJvbm1lbnQgKyBcIi1wcm92aXNpb24tdGVtcGxhdGVcIixcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBwcm92aXNpb25pbmdSb2xlQXJuOiByb2xlUHJvdmlzaW9uaW5nLnJvbGVBcm4sXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVCb2R5OiBKU09OLnN0cmluZ2lmeSh0ZXN0UHJvdmlzaW9uaW5nVGVtcGxhdGVKc29uKSxcbiAgICAgICAgICAgICAgICBlbmFibGVkOiB0cnVlLFxuICAgICAgICAgICAgICAgIHByZVByb3Zpc2lvbmluZ0hvb2s6IHtcbiAgICAgICAgICAgICAgICAgICAgXCJwYXlsb2FkVmVyc2lvblwiOiBcIjIwMjAtMDQtMDFcIixcbiAgICAgICAgICAgICAgICAgICAgXCJ0YXJnZXRBcm5cIjogbGFtYmRhUHJlUHJvdmlzaW9uaW5nSG9vay5mdW5jdGlvbkFyblxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IFwiQVdTIElvVCBQcm92aXNpb25pbmcgVGVtcGxhdGVcIixcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZU5hbWU6IENvbmZpZy5hcHAuc2VydmljZSArIFwiLVwiICsgQ29uZmlnLmFwcC5lbnZpcm9ubWVudCArIFwiLXByb3Zpc2lvbi10ZW1wbGF0ZVwiLFxuICAgICAgICAgICAgfVxuICAgICAgICApO1xuXG4gICAgICAgIC8vIE1vZGlmeSB0ZXN0RGV2aWNlQ2xhaW1DZXJ0aWZpY2F0ZVBvbGljeUpzb24gYW5kIGNyZWF0ZSB2ZWhpY2xlIGdhdGV3YXkgcG9saWN5IGZvciBDbGFpbSBDZXJ0aWZpY2F0ZVxuICAgICAgICBsZXQgdGVtcGxhdGVUb3BpY0NyZWF0ZSA9IGBhcm46YXdzOmlvdDoke0NvbmZpZy5hd3MucmVnaW9ufToke0NvbmZpZy5hd3MuYWNjb3VudH06dG9waWMvJGF3cy9jZXJ0aWZpY2F0ZXMvY3JlYXRlLypgXG4gICAgICAgIGxldCB0ZW1wbGF0ZVRvcGljUHJvdmlzaW9uaW5nID0gYGFybjphd3M6aW90OiR7Q29uZmlnLmF3cy5yZWdpb259OiR7Q29uZmlnLmF3cy5hY2NvdW50fTp0b3BpYy8kYXdzL3Byb3Zpc2lvbmluZy10ZW1wbGF0ZXMvJHt0ZXN0UHJvdmlzaW9uaW5nVGVtcGxhdGUudGVtcGxhdGVOYW1lfS9wcm92aXNpb24vKmBcbiAgICAgICAgdGVzdERldmljZUNsYWltQ2VydGlmaWNhdGVQb2xpY3lKc29uLlN0YXRlbWVudFsxXS5SZXNvdXJjZSA9IFt0ZW1wbGF0ZVRvcGljQ3JlYXRlLCB0ZW1wbGF0ZVRvcGljUHJvdmlzaW9uaW5nXVxuXG4gICAgICAgIGxldCB0ZW1wbGF0ZVRvcGljRmlsdGVyQ3JlYXRlID0gYGFybjphd3M6aW90OiR7Q29uZmlnLmF3cy5yZWdpb259OiR7Q29uZmlnLmF3cy5hY2NvdW50fTp0b3BpY2ZpbHRlci8kYXdzL2NlcnRpZmljYXRlcy9jcmVhdGUvKmBcbiAgICAgICAgbGV0IHRlbXBsYXRlVG9waWNGaWx0ZXJQcm92aXNpb25pbmcgPSBgYXJuOmF3czppb3Q6JHtDb25maWcuYXdzLnJlZ2lvbn06JHtDb25maWcuYXdzLmFjY291bnR9OnRvcGljZmlsdGVyLyRhd3MvcHJvdmlzaW9uaW5nLXRlbXBsYXRlcy8ke3Rlc3RQcm92aXNpb25pbmdUZW1wbGF0ZS50ZW1wbGF0ZU5hbWV9L3Byb3Zpc2lvbi8qYFxuICAgICAgICB0ZXN0RGV2aWNlQ2xhaW1DZXJ0aWZpY2F0ZVBvbGljeUpzb24uU3RhdGVtZW50WzJdLlJlc291cmNlID0gW3RlbXBsYXRlVG9waWNGaWx0ZXJDcmVhdGUsIHRlbXBsYXRlVG9waWNGaWx0ZXJQcm92aXNpb25pbmddXG5cbiAgICAgICAgbGV0IHRlc3REZXZpY2VDbGFpbUNlcnRpZmljYXRlUG9saWN5ID0gbmV3IGlvdC5DZm5Qb2xpY3koXG4gICAgICAgICAgICB0aGlzLCBDb25maWcuYXBwLnNlcnZpY2UgKyBcIi1cIiArIENvbmZpZy5hcHAuZW52aXJvbm1lbnQgKyBcIi1jbGFpbS1jZXJ0aWZpY2F0ZS1wb2xpY3lcIixcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBwb2xpY3lEb2N1bWVudDogdGVzdERldmljZUNsYWltQ2VydGlmaWNhdGVQb2xpY3lKc29uLFxuICAgICAgICAgICAgICAgIHBvbGljeU5hbWU6IENvbmZpZy5hcHAuc2VydmljZSArIFwiLVwiICsgQ29uZmlnLmFwcC5lbnZpcm9ubWVudCArIFwiLWNsYWltLWNlcnRpZmljYXRlLXBvbGljeVwiLFxuICAgICAgICAgICAgfVxuICAgICAgICApO1xuXG4gICAgICAgIC8vIENyZWF0ZSBjbGFpbSBjZXJ0aWZpY2F0ZSBieSB1c2luZyBBd3NDdXN0b21SZXNvdXJjZVxuICAgICAgICBsZXQgY3JlYXRlS2V5c0FuZENlcnRpZmljYXRlRm9yQ2xhaW1DZXJ0aWZpY2F0ZSA9IG5ldyBBd3NDdXN0b21SZXNvdXJjZShcbiAgICAgICAgICAgIHRoaXMsIENvbmZpZy5hcHAuc2VydmljZSArIFwiLVwiICsgQ29uZmlnLmFwcC5lbnZpcm9ubWVudCArIFwiLWNyZWF0ZS1rZXlzLWFuZC1jZXJ0aWZpY2F0ZS1mb3ItY2xhaW0tY2VydGlmaWNhdGVcIixcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBvblVwZGF0ZToge1xuICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlOiBcIklvdFwiLFxuICAgICAgICAgICAgICAgICAgICBhY3Rpb246IFwiY3JlYXRlS2V5c0FuZENlcnRpZmljYXRlXCIsXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlcnM6IHtzZXRBc0FjdGl2ZTogdHJ1ZX0sXG4gICAgICAgICAgICAgICAgICAgIHBoeXNpY2FsUmVzb3VyY2VJZDogUGh5c2ljYWxSZXNvdXJjZUlkLmZyb21SZXNwb25zZShcImNlcnRpZmljYXRlSWRcIiksXG4gICAgICAgICAgICAgICAgICAgIG91dHB1dFBhdGhzOiBbXCJjZXJ0aWZpY2F0ZUFyblwiLCBcImNlcnRpZmljYXRlUGVtXCIsIFwia2V5UGFpci5QdWJsaWNLZXlcIiwgXCJrZXlQYWlyLlByaXZhdGVLZXlcIl0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBwb2xpY3k6IEF3c0N1c3RvbVJlc291cmNlUG9saWN5LmZyb21TZGtDYWxscyh7cmVzb3VyY2VzOiBBd3NDdXN0b21SZXNvdXJjZVBvbGljeS5BTllfUkVTT1VSQ0V9KSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuXG4gICAgICAgIC8vIEF0dGFjaCBwb2xpY3kgdG8gY2xhaW0gY2VydGlmaWNhdGVcbiAgICAgICAgbGV0IFBvbGljeVByaW5jaXBhbEF0dGFjaG1lbnRGb3JDbGFpbUNlcnRpZmljYXRlID1cbiAgICAgICAgICAgIG5ldyBpb3QuQ2ZuUG9saWN5UHJpbmNpcGFsQXR0YWNobWVudChcbiAgICAgICAgICAgICAgICB0aGlzLCBDb25maWcuYXBwLnNlcnZpY2UgKyBcIi1cIiArIENvbmZpZy5hcHAuZW52aXJvbm1lbnQgKyBcInBvbGljeS1wcmluY2lwYWwtYXR0YWNobWVudFwiLCB7XG4gICAgICAgICAgICAgICAgICAgIHBvbGljeU5hbWU6IHRlc3REZXZpY2VDbGFpbUNlcnRpZmljYXRlUG9saWN5LnBvbGljeU5hbWUhLFxuICAgICAgICAgICAgICAgICAgICBwcmluY2lwYWw6IGNyZWF0ZUtleXNBbmRDZXJ0aWZpY2F0ZUZvckNsYWltQ2VydGlmaWNhdGUuZ2V0UmVzcG9uc2VGaWVsZChcImNlcnRpZmljYXRlQXJuXCIpLFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgbGV0IGNka1Rlc3RTM0J1Y2tldCA9IG5ldyBzMy5CdWNrZXQodGhpcywgJ2Nka1Rlc3RTM0J1Y2tldCcsIHtcbiAgICAgICAgICAgIGJsb2NrUHVibGljQWNjZXNzOiBzMy5CbG9ja1B1YmxpY0FjY2Vzcy5CTE9DS19BTEwsXG4gICAgICAgICAgICB2ZXJzaW9uZWQ6IHRydWUsXG4gICAgICAgICAgICByZW1vdmFsUG9saWN5OiBSZW1vdmFsUG9saWN5LlJFVEFJTl9PTl9VUERBVEVfT1JfREVMRVRFLFxuICAgICAgICAgICAgLy8gYXV0b0RlbGV0ZU9iamVjdHM6IHRydWUsXG4gICAgICAgICAgICBidWNrZXROYW1lOiBDb25maWcuczNCdWNrZXROYW1lXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFNhdmUgdGhlIHZlaGljbGUtZ2F0ZXdheSBjZXJ0aWZpY2F0ZXMgYW5kIGtleXMgdG8gUzNcbiAgICAgICAgbGV0IGtleURlcGxveW1lbnRGb3JEZXZpY2VDbGFpbUNlcnRpZmljYXRlID0gbmV3IGF3c19zM19kZXBsb3ltZW50LkJ1Y2tldERlcGxveW1lbnQoXG4gICAgICAgICAgICB0aGlzLCBDb25maWcuYXBwLnNlcnZpY2UgKyBcIi1cIiArIENvbmZpZy5hcHAuZW52aXJvbm1lbnQgKyBcInB1dC1rZXktdG8tczNcIixcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbkJ1Y2tldDogY2RrVGVzdFMzQnVja2V0LFxuICAgICAgICAgICAgICAgIHNvdXJjZXM6IFtcbiAgICAgICAgICAgICAgICAgICAgYXdzX3MzX2RlcGxveW1lbnQuU291cmNlLmRhdGEoXG4gICAgICAgICAgICAgICAgICAgICAgICBcImNsYWltLWNlcnRpZmljYXRlL2NsYWltLnBlbVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlS2V5c0FuZENlcnRpZmljYXRlRm9yQ2xhaW1DZXJ0aWZpY2F0ZS5nZXRSZXNwb25zZUZpZWxkKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiY2VydGlmaWNhdGVQZW1cIlxuICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICBhd3NfczNfZGVwbG95bWVudC5Tb3VyY2UuZGF0YShcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiY2xhaW0tY2VydGlmaWNhdGUvY2xhaW0ucHVibGljLmtleVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlS2V5c0FuZENlcnRpZmljYXRlRm9yQ2xhaW1DZXJ0aWZpY2F0ZS5nZXRSZXNwb25zZUZpZWxkKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwia2V5UGFpci5QdWJsaWNLZXlcIlxuICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICBhd3NfczNfZGVwbG95bWVudC5Tb3VyY2UuZGF0YShcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiY2xhaW0tY2VydGlmaWNhdGUvY2xhaW0ucHJpdmF0ZS5rZXlcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZUtleXNBbmRDZXJ0aWZpY2F0ZUZvckNsYWltQ2VydGlmaWNhdGUuZ2V0UmVzcG9uc2VGaWVsZChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImtleVBhaXIuUHJpdmF0ZUtleVwiXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=